<!DOCTYPE html PUBLIC "-//IETF//DTD HTML 2.0//EN">
<HTML>
<HEAD>
<TITLE>Enscript Output</TITLE>
</HEAD>
<BODY>
<A NAME="top">
<A NAME="file1">
<H1>src/ring_buffer.rs</H1>

<PRE>
/*
    Pop: O(1)
    Arbitrary get: O(1)
*/

pub struct RingBuffer&lt;T&gt; {
    buffer: Vec&lt;T&gt;,
    reader: usize, // Modular offset in the buffer
}

impl&lt;T&gt; RingBuffer&lt;T&gt;
where
    T: Default + Clone,
{
    pub fn with_capacity(capacity: usize) -&gt; Self {
        if capacity == 0 {
            panic!(&quot;Capacity should be strictly positive&quot;);
        }

        let mut buffer = Vec::with_capacity(capacity);
        buffer.resize(capacity, T::default());
        Self { buffer, reader: 0 }
    }

    pub fn pop(&amp;mut self) -&gt; T {
        let elem = {
            let in_buf = unsafe { self.buffer.get_unchecked_mut(self.reader) };
            std::mem::replace(in_buf, T::default())
        };

        // Optimized modular increment
        // &lt;=&gt; self.reader = (self.reader + 1) % self.buffer.len();
        self.reader += 1;
        if self.reader == self.buffer.len() {
            self.reader = 0;
        }

        elem
    }

    pub fn get(&amp;self, index: usize) -&gt; Option&lt;&amp;T&gt; {
        if index &lt; self.buffer.len() {
            let index = self.reader + index;
            if index &gt;= self.buffer.len() {
                let index = index - self.buffer.len();
                self.buffer.get(index)
            } else {
                self.buffer.get(index)
            }
        } else {
            None
        }
    }

    pub fn get_mut(&amp;mut self, index: usize) -&gt; Option&lt;&amp;mut T&gt; {
        if index &lt; self.buffer.len() {
            let index = self.reader + index;
            if index &gt;= self.buffer.len() {
                let index = index - self.buffer.len();
                self.buffer.get_mut(index)
            } else {
                self.buffer.get_mut(index)
            }
        } else {
            None
        }
    }

    pub fn len(&amp;self) -&gt; usize {
        self.buffer.len()
    }
}
</PRE>
<HR>
<ADDRESS>Generated by <A HREF="http://www.iki.fi/~mtr/genscript/">GNU Enscript 1.6.5.90</A>.</ADDRESS>
</BODY>
</HTML>
